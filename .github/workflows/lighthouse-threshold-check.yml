name: Lighthouse Threshold Check

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types: [completed]
    branches: [main]
  workflow_dispatch: # Manual trigger for testing

permissions:
  contents: write
  pull-requests: write

jobs:
  check-thresholds:
    # Only run if CI/CD was successful
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Run Lighthouse (10 times for confidence)
        run: npx lhci autorun --config=test-suite/configs/lighthouse-threshold-check.config.js

      - name: Analyze scores and check for updates
        id: analyze
        run: |
          # Run the analysis script
          result=$(node test-suite/scripts/propose-threshold-updates.js)

          # Save result to file for parsing
          echo "$result" > /tmp/analysis-result.json

          # Extract values
          shouldUpdate=$(jq -r '.shouldUpdate' /tmp/analysis-result.json)
          message=$(jq -r '.message // .summary // "Analysis complete"' /tmp/analysis-result.json)

          # Display formatted analysis
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  LIGHTHOUSE THRESHOLD ANALYSIS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Decision: $([ "$shouldUpdate" = "true" ] && echo "ðŸ”„ UPDATE NEEDED" || echo "âœ… NO UPDATE NEEDED")"
          echo "Summary: $message"
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "  CATEGORY ANALYSIS"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo ""

          # Display each category's analysis
          jq -r '.analysis[] | "Category: \(.category)\n  Current Threshold: \(.currentThreshold)\n  Median Score:      \(.medianScore)\n  Improvement:       \(.improvement)\n  Action:            \(.action)\n  Reason:            \(.reason)\n"' /tmp/analysis-result.json

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # Set output
          echo "shouldUpdate=$shouldUpdate" >> $GITHUB_OUTPUT

          if [ "$shouldUpdate" = "true" ]; then
            # Extract PR details
            prTitle=$(jq -r '.prTitle' /tmp/analysis-result.json)
            echo "prTitle=$prTitle" >> $GITHUB_OUTPUT

            # Save body to file (multi-line)
            jq -r '.prBody' /tmp/analysis-result.json > /tmp/pr-body.md

            # Apply updates to config file
            node test-suite/scripts/propose-threshold-updates.js --apply
          fi

      - name: Disable git hooks for automated PR
        if: steps.analyze.outputs.shouldUpdate == 'true'
        run: git config core.hooksPath /dev/null

      - name: Create Pull Request
        if: steps.analyze.outputs.shouldUpdate == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: lighthouse-threshold-update
          delete-branch: true
          title: ${{ steps.analyze.outputs.prTitle }}
          body-path: /tmp/pr-body.md
          commit-message: |
            ${{ steps.analyze.outputs.prTitle }}

            Generated with [Claude Code](https://claude.com/claude-code)
          labels: |
            enhancement
            automated
